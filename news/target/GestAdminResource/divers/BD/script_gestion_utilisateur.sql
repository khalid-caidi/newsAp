/***
 * SCRIPT BD GESTION DECOMPTES - UTILISATEUR
 * SQL SERVER
 * 
 * ZGUIOUAR 
 */

-- DROP TABLES

DROP TABLE PROFIL_ROLE;
DROP TABLE ROLE;
DROP TABLE AUTORISATION;
DROP TABLE PROFIL;
DROP TABLE PORT_TERMINAL
DROP TABLE UTILISATEUR;
DROP TABLE SITE;
DROP TABLE TERMINAL;
DROP TABLE PORT;

--

CREATE TABLE
    UTILISATEUR
    (
        ID_USER INTEGER NOT NULL IDENTITY,
        USERNAME VARCHAR(40) NOT NULL,
        PWD VARCHAR(200) NOT NULL,
        EMAIL VARCHAR(50) NOT NULL,
        PWD_RESET VARCHAR(50) ,
        PWD_CLAIR VARCHAR(200) ,
        IND_SUPP INT DEFAULT 1,
        USER_CREAT VARCHAR(20) NOT NULL,
        DAT_CREAT DATETIME DEFAULT GETDATE() NOT NULL,
        USER_MODIF VARCHAR(20) ,
        DAT_MODIF DATETIME,
        CONSTRAINT PK_ID_USER PRIMARY KEY (ID_USER)
    );
	
CREATE TABLE
    ROLE
    (
        ID_ROLE INTEGER  NOT NULL IDENTITY,
        COD_ROLE VARCHAR(100) NOT NULL,
        LIB_ROLE VARCHAR(100) NOT NULL,
        NUM_ORDRE INTEGER  NOT NULL,
        USER_CREAT VARCHAR(20) NOT NULL,
        DAT_CREAT DATETIME DEFAULT GETDATE() NOT NULL,
        CONSTRAINT PK_ROLE PRIMARY KEY (ID_ROLE),
        CONSTRAINT INDEX_UNIQUE_COD_ROLE UNIQUE (COD_ROLE),
        CONSTRAINT INDEX_UNIQUE_LIB_ROLE UNIQUE (LIB_ROLE)
    );
	
CREATE TABLE
    PROFIL
    (
        ID_PROFIL INTEGER  NOT NULL IDENTITY,
        COD_PROFIL VARCHAR(30) NOT NULL,
        LIB_PROFIL VARCHAR(100) NOT NULL,
        USER_CREAT VARCHAR(20) NOT NULL,
        DAT_CREAT DATETIME DEFAULT GETDATE() NOT NULL,
        USER_MODIF VARCHAR(20) ,
        DAT_MODIF DATETIME,
        CONSTRAINT PK_PROFIL PRIMARY KEY (ID_PROFIL),
        CONSTRAINT INDEX_UNIQUE_COD_PROFIL UNIQUE (COD_PROFIL),
        CONSTRAINT INDEX_UNIQUE_LIB_PROFIL UNIQUE (LIB_PROFIL)
    );

CREATE TABLE
    PROFIL_ROLE
    (
        ID_PROFIL INTEGER  NOT NULL,
        ID_ROLE INTEGER  NOT NULL,
        CONSTRAINT PK_PROFIL_ROLE PRIMARY KEY (ID_PROFIL, ID_ROLE)
    );
ALTER TABLE
    PROFIL_ROLE ADD CONSTRAINT FK_ID_PROFIL_PROFIL_ROLE FOREIGN KEY (ID_PROFIL) REFERENCES PROFIL (ID_PROFIL);
ALTER TABLE
    PROFIL_ROLE ADD CONSTRAINT FK_ID_ROLE_PROFIL_ROLE FOREIGN KEY (ID_ROLE) REFERENCES ROLE (ID_ROLE);      
	
CREATE TABLE
    PORT
    (
        ID_PORT INTEGER  NOT NULL IDENTITY,
        COD_PORT VARCHAR(50) NOT NULL,
        LIB_PORT VARCHAR(100) NOT NULL,
        USER_CREAT VARCHAR(20) NOT NULL,
        DAT_CREAT DATETIME DEFAULT GETDATE() NOT NULL,
        CONSTRAINT PK_PORT PRIMARY KEY (ID_PORT),
        CONSTRAINT INDEX_UNIQUE_COD_PORT UNIQUE (COD_PORT),
        CONSTRAINT INDEX_UNIQUE_LIB_PORT UNIQUE (LIB_PORT)
    );
	
CREATE TABLE
    TERMINAL
    (
        ID_TERMINAL INTEGER  NOT NULL IDENTITY,
        ID_PORT INTEGER,
        COD_TERMINAL VARCHAR(50) NOT NULL,
        LIB_TERMINAL VARCHAR(100) NOT NULL,
        USER_CREAT VARCHAR(20) NOT NULL,
        DAT_CREAT DATETIME DEFAULT GETDATE() NOT NULL,
        CONSTRAINT PK_TERMINAL PRIMARY KEY (ID_TERMINAL)
    );    
ALTER TABLE
    TERMINAL ADD CONSTRAINT FK_ID_PORT_TERMINAL FOREIGN KEY (ID_PORT) REFERENCES PORT (ID_PORT);
ALTER TABLE 
	TERMINAL ADD CONSTRAINT INDEX_COD_TERMINAL_TERMINAL UNIQUE (COD_TERMINAL);     

CREATE TABLE
    SITE
    (
        ID_SITE INTEGER  NOT NULL IDENTITY,
        ID_TERMINAL INTEGER NOT NULL,
        COD_SITE VARCHAR(50) NOT NULL,
        LIB_SITE VARCHAR(100) NOT NULL,
        COD_ISO VARCHAR(50) ,
        IND_SUPP INT DEFAULT 1,
        USER_CREAT VARCHAR(20) NOT NULL,
        DAT_CREAT DATETIME DEFAULT GETDATE() NOT NULL,
        USER_MODIF VARCHAR(20) ,
        DAT_MODIF DATETIME,
        CONSTRAINT PK_SITE PRIMARY KEY (ID_SITE),
        CONSTRAINT INDEX_UNIQUE_COD_SITE UNIQUE (COD_SITE)
    );
ALTER TABLE
    SITE ADD CONSTRAINT FK_ID_TERMINAL_SITE FOREIGN KEY (ID_TERMINAL) REFERENCES TERMINAL (ID_TERMINAL);
	

CREATE TABLE
    AUTORISATION
    (
        ID_AUTORISATION INTEGER NOT NULL IDENTITY,
        ID_USER INTEGER NOT NULL,
        ID_SITE INTEGER NOT NULL,
        ID_PROFIL INTEGER  NOT NULL,
        CONSTRAINT PK_AUTORISATION PRIMARY KEY (ID_AUTORISATION),
        CONSTRAINT INDEX_UNIQUE_AUTORISATION UNIQUE (ID_USER, ID_SITE, ID_PROFIL)
    );
ALTER TABLE
    AUTORISATION ADD CONSTRAINT FK_ID_USER_AUTORISATION FOREIGN KEY (ID_USER) REFERENCES UTILISATEUR (ID_USER);
ALTER TABLE
    AUTORISATION ADD CONSTRAINT FK_ID_SITE_AUTORISATION FOREIGN KEY (ID_SITE) REFERENCES SITE (ID_SITE); 
ALTER TABLE
    AUTORISATION ADD CONSTRAINT FK_ID_PROFIL_AUTORISATION FOREIGN KEY (ID_PROFIL) REFERENCES PROFIL (ID_PROFIL);	
